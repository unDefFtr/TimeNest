name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: false
        default: 'dev-build'

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            arch: x64
            python-version: '3.11'
            executable-suffix: '.exe'
            artifact-name: 'TimeNest-Windows-x64'
          - os: macos-latest
            platform: macos
            arch: x64
            python-version: '3.11'
            executable-suffix: ''
            artifact-name: 'TimeNest-macOS-x64'
          - os: ubuntu-latest
            platform: linux
            arch: x64
            python-version: '3.11'
            executable-suffix: ''
            artifact-name: 'TimeNest-Linux-x64'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    # Linux ç³»ç»Ÿä¾èµ–
    - name: Install Linux dependencies
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-glx \
          libglib2.0-0 \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-xfixes0 \
          libegl1-mesa \
          libxcb-cursor0

    # macOS ç³»ç»Ÿä¾èµ–
    - name: Install macOS dependencies
      if: matrix.platform == 'macos'
      run: |
        # å®‰è£…å¿…è¦çš„ç³»ç»Ÿåº“
        brew install create-dmg

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install nuitka>=1.8.0
        pip install -r requirements.txt
        # å®‰è£…é¢å¤–çš„æ‰“åŒ…ä¾èµ–
        pip install ordered-set zstandard

    # Windows ç‰¹å®šçš„ä¾èµ–
    - name: Install Windows build tools
      if: matrix.platform == 'windows'
      run: |
        # å®‰è£… Windows SDK å’Œ Visual Studio Build Toolsï¼ˆé€šè¿‡ chocolateyï¼‰
        choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools"

    - name: Get version
      id: get_version
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="dev-$(git rev-parse --short HEAD)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    # Windows æ‰“åŒ…
    - name: Build with Nuitka (Windows)
      if: matrix.platform == 'windows'
      run: |
        python -m nuitka \
          --standalone \
          --onefile \
          --enable-plugin=pyqt6 \
          --windows-console-mode=disable \
          --windows-icon-from-ico=resources/icons/tray_icon.png \
          --include-data-dir=resources=resources \
          --include-package=core \
          --include-package=ui \
          --include-package=components \
          --include-package=models \
          --include-package=utils \
          --include-package=sdk \
          --assume-yes-for-downloads \
          --output-filename=TimeNest-${{ steps.get_version.outputs.version }}-Windows-x64.exe \
          main.py

    # macOS æ‰“åŒ…
    - name: Build with Nuitka (macOS)
      if: matrix.platform == 'macos'
      run: |
        python -m nuitka \
          --standalone \
          --onefile \
          --enable-plugin=pyqt6 \
          --macos-create-app-bundle \
          --macos-app-icon=resources/icons/tray_icon.png \
          --include-data-dir=resources=resources \
          --include-package=core \
          --include-package=ui \
          --include-package=components \
          --include-package=models \
          --include-package=utils \
          --include-package=sdk \
          --assume-yes-for-downloads \
          --output-filename=TimeNest-${{ steps.get_version.outputs.version }}-macOS-x64 \
          main.py

    # Linux æ‰“åŒ…
    - name: Build with Nuitka (Linux)
      if: matrix.platform == 'linux'
      run: |
        python -m nuitka \
          --standalone \
          --onefile \
          --enable-plugin=pyqt6 \
          --linux-icon=resources/icons/tray_icon.png \
          --include-data-dir=resources=resources \
          --include-package=core \
          --include-package=ui \
          --include-package=components \
          --include-package=models \
          --include-package=utils \
          --include-package=sdk \
          --assume-yes-for-downloads \
          --output-filename=TimeNest-${{ steps.get_version.outputs.version }}-Linux-x64 \
          main.py

    # åˆ›å»º macOS DMG åŒ…
    - name: Create macOS DMG
      if: matrix.platform == 'macos'
      run: |
        mkdir -p dist
        # å¦‚æžœç”Ÿæˆäº† .app åŒ…ï¼Œåˆ›å»º DMG
        if [ -d "main.app" ]; then
          mv main.app "TimeNest.app"
          create-dmg \
            --volname "TimeNest" \
            --window-pos 200 120 \
            --window-size 600 300 \
            --icon-size 100 \
            --icon "TimeNest.app" 175 120 \
            --hide-extension "TimeNest.app" \
            --app-drop-link 425 120 \
            "dist/TimeNest-${{ steps.get_version.outputs.version }}-macOS-x64.dmg" \
            "TimeNest.app"
        else
          # å¦‚æžœæ˜¯å•æ–‡ä»¶ï¼Œç›´æŽ¥ç§»åŠ¨
          mv TimeNest-${{ steps.get_version.outputs.version }}-macOS-x64 dist/
        fi

    # ç§»åŠ¨æž„å»ºäº§ç‰©åˆ° dist ç›®å½•
    - name: Organize build artifacts
      shell: bash
      run: |
        mkdir -p dist
        
        # Windows
        if [ "${{ matrix.platform }}" == "windows" ]; then
          mv TimeNest-${{ steps.get_version.outputs.version }}-Windows-x64.exe dist/
        fi
        
        # Linux
        if [ "${{ matrix.platform }}" == "linux" ]; then
          mv TimeNest-${{ steps.get_version.outputs.version }}-Linux-x64 dist/
          chmod +x dist/TimeNest-${{ steps.get_version.outputs.version }}-Linux-x64
        fi
        
        # macOS (å¦‚æžœæ²¡æœ‰åˆ›å»º DMG)
        if [ "${{ matrix.platform }}" == "macos" ] && [ ! -f "dist/TimeNest-${{ steps.get_version.outputs.version }}-macOS-x64.dmg" ]; then
          if [ -f "TimeNest-${{ steps.get_version.outputs.version }}-macOS-x64" ]; then
            mv TimeNest-${{ steps.get_version.outputs.version }}-macOS-x64 dist/
            chmod +x dist/TimeNest-${{ steps.get_version.outputs.version }}-macOS-x64
          fi
        fi
        
        # åˆ—å‡ºæž„å»ºäº§ç‰©
        echo "Build artifacts:"
        ls -la dist/

    # ä¸Šä¼ æž„å»ºäº§ç‰©
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact-name }}-${{ steps.get_version.outputs.version }}
        path: dist/
        retention-days: 30

  # åˆ›å»º Releaseï¼ˆä»…åœ¨æŽ¨é€æ ‡ç­¾æ—¶ï¼‰
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    # ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
    - name: Download Windows artifacts
      uses: actions/download-artifact@v3
      with:
        name: TimeNest-Windows-x64-${{ steps.get_version.outputs.version }}
        path: ./artifacts/windows/

    - name: Download macOS artifacts
      uses: actions/download-artifact@v3
      with:
        name: TimeNest-macOS-x64-${{ steps.get_version.outputs.version }}
        path: ./artifacts/macos/

    - name: Download Linux artifacts
      uses: actions/download-artifact@v3
      with:
        name: TimeNest-Linux-x64-${{ steps.get_version.outputs.version }}
        path: ./artifacts/linux/

    # ç”Ÿæˆ Release Notes
    - name: Generate Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## TimeNest ${{ steps.get_version.outputs.version }}
        
        ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        
        - **Windows ç”¨æˆ·**: ä¸‹è½½ `TimeNest-*-Windows-x64.exe`
        - **macOS ç”¨æˆ·**: ä¸‹è½½ `TimeNest-*-macOS-x64.dmg` æˆ– `TimeNest-*-macOS-x64`
        - **Linux ç”¨æˆ·**: ä¸‹è½½ `TimeNest-*-Linux-x64`
        
        ### ðŸš€ æ–°åŠŸèƒ½
        
        - è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€macOSã€Linuxï¼‰
        - ä½¿ç”¨ Nuitka ç¼–è¯‘ï¼Œå¯åŠ¨é€Ÿåº¦æ›´å¿«
        - å•æ–‡ä»¶å¯æ‰§è¡Œç¨‹åºï¼Œæ— éœ€å®‰è£… Python çŽ¯å¢ƒ
        
        ### ðŸ“‹ ç³»ç»Ÿè¦æ±‚
        
        - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
        - **macOS**: macOS 10.14 æˆ–æ›´é«˜ç‰ˆæœ¬
        - **Linux**: æ”¯æŒ glibc 2.17+ çš„å‘è¡Œç‰ˆ
        
        ### ðŸ”§ å®‰è£…è¯´æ˜Ž
        
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
        2. Windows/Linux: ç›´æŽ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
        3. macOS: æŒ‚è½½ DMG æ–‡ä»¶å¹¶æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
        
        ### âš ï¸ æ³¨æ„äº‹é¡¹
        
        - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´è¿›è¡Œåˆå§‹åŒ–
        - å¦‚é‡åˆ°å®‰å…¨è­¦å‘Šï¼Œè¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸è¿è¡Œ
        - å»ºè®®åœ¨è¿è¡Œå‰å…³é—­æ€æ¯’è½¯ä»¶çš„å®žæ—¶ä¿æŠ¤
        
        EOF

    # åˆ›å»º GitHub Release
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: TimeNest ${{ steps.get_version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.version, 'alpha') || contains(steps.get_version.outputs.version, 'beta') || contains(steps.get_version.outputs.version, 'rc') }}
        files: |
          ./artifacts/windows/*
          ./artifacts/macos/*
          ./artifacts/linux/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # æ¸…ç†æž„å»ºç¼“å­˜ï¼ˆå¯é€‰ï¼‰
    - name: Cleanup
      run: |
        echo "Release created successfully!"
        echo "Download URLs will be available at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.version }}"